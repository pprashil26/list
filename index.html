<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Collections</title>
<style>
:root{
  --mint:#dff5ec;
  --brown:#3e2f25;
  --line:#c8e8dc;
}

*{
  box-sizing:border-box;
  margin:0;
  padding:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
  font-size:14px;
  color:var(--brown);
}

body{
  display:flex;
  height:100vh;
  background:var(--mint);
}

/* SIDEBAR */
.sidebar{
  width:140px;
  border-right:1px solid var(--line);
  overflow-y:auto;
  padding:4px 4px;
}

.list-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:3px 4px;
  cursor:pointer;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.list-item.active{
  font-weight:600;
}

.list-item span.delete{
  font-size:12px;
  color:var(--brown);
  cursor:pointer;
  padding-left:6px;
}

/* MAIN */
.main{
  flex:1;
  display:flex;
  flex-direction:column;
}

.header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:4px 8px;
  border-bottom:1px solid var(--line);
}

.header-left{
  display:flex;
  gap:8px;
  align-items:center;
}

.header-left span#styleLabel{
  font-size:12px;
  cursor:pointer;
}

/* TEXTAREA */
textarea{
  flex:1;
  border:none;
  outline:none;
  resize:none;
  padding:8px;
  line-height:1.4;
  background:
    repeating-linear-gradient(
      to bottom,
      transparent,
      transparent 22px,
      var(--line) 23px
    );
  font-family:monospace;
  color:var(--brown);
}
</style>
</head>
<body>

<div class="sidebar" id="sidebar">
  <button onclick="newList()">+ List</button>
</div>

<div class="main">
  <div class="header">
    <input id="listTitle" style="flex:1; border:none; outline:none; font-weight:500;" value="">
    <span id="styleLabel">•</span>
  </div>
  <textarea id="editor"></textarea>
</div>

<script>
let lists = JSON.parse(localStorage.getItem("collections_v03")) || [];
let activeId = null;

function save(){
  localStorage.setItem("collections_v03", JSON.stringify(lists));
}

function migrate(list){
  if(list.pinned === undefined) list.pinned = false;
  if(!list.listStyle) list.listStyle = "bullet";
  return list;
}

lists = lists.map(migrate);

function renderSidebar(){
  const sidebar = document.getElementById("sidebar");
  // Keep new list button at top
  sidebar.innerHTML = '<button onclick="newList()">+ List</button>';

  const sorted = [...lists].sort((a,b)=>{
    if(a.pinned === b.pinned) return 0;
    return a.pinned ? -1 : 1;
  });

  sorted.forEach(list=>{
    const div = document.createElement("div");
    div.className="list-item";
    if(list.id===activeId) div.classList.add("active");

    const nameSpan = document.createElement("span");
    nameSpan.textContent=list.title||"Untitled";
    nameSpan.onclick=()=>{
      activeId=list.id;
      renderSidebar();
      renderEditor();
    };

    const delSpan = document.createElement("span");
    delSpan.className="delete";
    delSpan.textContent="×";
    delSpan.onclick=(e)=>{
      e.stopPropagation();
      lists = lists.filter(l=>l.id!==list.id);
      if(lists.length) activeId=lists[0].id;
      else newList();
      save();
      renderSidebar();
      renderEditor();
    };

    div.appendChild(nameSpan);
    div.appendChild(delSpan);
    sidebar.appendChild(div);
  });
}

function renderEditor(){
  const editor = document.getElementById("editor");
  const list = lists.find(l=>l.id===activeId);
  if(!list) return;
  editor.value=list.content;
  document.getElementById("listTitle").value=list.title;
  updateStyleLabel();
}

function newList(){
  const id = Date.now().toString();
  const newItem = {
    id,
    title:"New List",
    content:"",
    pinned:false,
    listStyle:"bullet"
  };
  lists.push(newItem);
  activeId=id;
  save();
  renderSidebar();
  renderEditor();
}

document.getElementById("listTitle").addEventListener("input",function(){
  const list=lists.find(l=>l.id===activeId);
  if(!list) return;
  list.title=this.value||"Untitled";
  save();
  renderSidebar();
});

function updateStyleLabel(){
  const list = lists.find(l=>l.id===activeId);
  const lbl = document.getElementById("styleLabel");
  lbl.textContent = list.listStyle==="bullet"?"•":"1.";
}

document.getElementById("styleLabel").onclick=function(){
  const list=lists.find(l=>l.id===activeId);
  if(!list) return;
  list.listStyle = list.listStyle==="bullet"?"number":"bullet";
  save();
  updateStyleLabel();
};

document.getElementById("editor").addEventListener("input", function(){
  const list=lists.find(l=>l.id===activeId);
  if(!list) return;
  list.content=this.value;
  save();
});

document.getElementById("editor").addEventListener("keydown", function(e){
  if(e.key==="Enter"){
    const list=lists.find(l=>l.id===activeId);
    if(!list) return;

    const start=this.selectionStart;
    const text=this.value.substring(0,start);
    const lines=text.split("\n");
    const lastLine=lines[lines.length-1];

    let prefix="";

    if(list.listStyle==="bullet"){
      prefix="- ";
    }else{
      const match=lastLine.match(/^(\d+)\./);
      const next=match?parseInt(match[1])+1:1;
      prefix=next+". ";
    }

    setTimeout(()=>{
      const pos=this.selectionStart;
      this.value=this.value.substring(0,pos)+prefix+this.value.substring(pos);
      this.selectionStart=this.selectionEnd=pos+prefix.length;
      list.content=this.value;
      save();
    },0);
  }
});

// Initialize
if(lists.length){
  activeId=lists[0].id;
}else{
  newList();
}
renderSidebar();
renderEditor();
</script>

</body>
</html>